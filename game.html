<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game B√© √în B√†i (v20 - Ch·ªçn B√†i)</title>
    <style>
        /* --- Ph·∫ßn 1: CSS --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f8ff;
            display: flex;
            justify-content: center;
            align-items: center; /* CƒÉn gi·ªØa m√†n h√¨nh b·∫Øt ƒë·∫ßu */
            padding-top: 5vh;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }

        /* [M·ªöI] M√†n h√¨nh B·∫Øt ƒë·∫ßu */
        #start-screen {
            width: 90%;
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            border: 5px solid #4a90e2;
            text-align: center;
        }
        #start-screen h1 {
            font-size: 3em;
            font-weight: bold;
            color: #4a90e2;
            margin-top: 0;
        }
        #start-screen p {
            font-size: 1.5em;
            font-weight: 500;
            margin-bottom: 20px;
        }
        #lesson-select {
            font-size: 1.5em;
            font-weight: bold;
            padding: 15px;
            width: 100%;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 25px;
            cursor: pointer;
        }
        #start-btn {
            font-size: 1.8em;
            font-weight: bold;
            padding: 20px 40px;
            border: none;
            border-radius: 10px;
            background-color: #28a745; /* M√†u xanh l√° */
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }
        #start-btn:hover {
            background-color: #218838;
        }

        /* [M·ªöI] ·∫®n game ch√≠nh ban ƒë·∫ßu */
        #main-layout {
            display: none; /* ·∫®n ban ƒë·∫ßu */
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
        }
        
        #game-container {
            width: 700px;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            border: 5px solid #4a90e2;
        }
        #stats-container {
            width: 250px;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 20px 30px;
            border: 5px solid #ff6b6b;
        }
        #stats-container h3 {
            font-size: 1.8em;
            font-weight: bold;
            color: #ff6b6b;
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            border-bottom: 2px dashed #ddd;
            padding-bottom: 10px;
        }
        #chart-bar-container {
            width: 100px;
            height: 300px;
            background-color: #f0f0f0;
            border: 3px solid #eee;
            border-radius: 10px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        #chart-bar-correct {
            width: 100%;
            height: 0%;
            background-color: #00ffaa;
            position: absolute;
            bottom: 0;
            left: 0;
            transition: height 0.5s ease-out;
            box-shadow: 0 0 10px #00ffaa, 0 0 20px #00ffaa, 0 0 30px #00ffaa, 0 0 40px #00ffaa;
        }
        #chart-label { text-align: center; font-size: 1.8em; font-weight: bold; color: #333; margin-top: 15px; }
        #header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed #ddd; padding-bottom: 15px; margin-bottom: 20px; gap: 10px; }
        #score { font-size: 1.5em; font-weight: bold; color: #ff6b6b; background-color: #fff0f0; padding: 10px 20px; border-radius: 10px; order: 3; }
        #title { font-size: 2em; font-weight: bold; color: #4a90e2; order: 1; flex-grow: 1; }
        #end-btn { font-size: 1.1em; font-weight: bold; padding: 10px 20px; border: none; border-radius: 10px; background-color: #dc3545; color: white; cursor: pointer; transition: background-color 0.2s; order: 2; display: none; }
        #end-btn:hover { background-color: #c82333; }
        #question-area { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
        #question-text { font-size: 1.8em; font-weight: 500; margin: 0; line-height: 1.5; }
        #speaker-btn { font-size: 2.5em; cursor: pointer; background: none; border: none; padding: 0; flex-shrink: 0; transition: transform 0.2s; }
        #speaker-btn:hover { transform: scale(1.2); }

        /* --- CSS D·∫°ng 2: B·∫•m t√¨m (v17) --- */
        #sentence-container.click-find {
            font-size: 2.2em;
            font-weight: bold;
            line-height: 1.8;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            min-height: 50px;
        }
        #sentence-container.click-find .token {
            cursor: pointer;
            padding: 0 1px;
            border-radius: 5px;
            user-select: none;
            transition: all 0.2s;
            display: inline-block;
            margin: 0 1px;
            border: 2px solid transparent;
        }
        #sentence-container.click-find .token:hover { background-color: #f0f8ff; }
        #sentence-container.click-find .space { padding: 0 5px; user-select: none; }
        #sentence-container.click-find .selected { background-color: #fffbe6; color: #f5a623; border-color: #f5a623; }
        #sentence-container.click-find .correct { background-color: #e0ffe0; color: #28a745; border-color: #28a745; pointer-events: none; }
        #sentence-container.click-find .incorrect { background-color: #ffcccc; color: #dc3545; border-color: #dc3545; text-decoration: line-through; }
        
        /* --- CSS D·∫°ng 1, 3, 4, 5: Tr·∫Øc nghi·ªám --- */
        #answer-options.multiple-choice { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn { font-size: 1.5em; font-weight: bold; padding: 20px; border: 2px solid #ddd; border-radius: 10px; background-color: #fdfdfd; cursor: pointer; transition: all 0.2s; }
        .option-btn:hover { background-color: #f0f8ff; border-color: #4a90e2; }
        .option-btn:disabled { opacity: 0.6; pointer-events: none; }
        .option-btn.incorrect { background-color: #ffcccc; border-color: #dc3545; opacity: 0.6; pointer-events: none; }
        .option-btn.correct { background-color: #e0ffe0; border-color: #28a745; }
        
        /* --- CSS D·∫°ng 6: S·∫Øp x·∫øp t·ª´ --- */
        #answer-options.scramble-bank { display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: #f9f9f9; border-radius: 10px; }
        .word-bank-btn { font-size: 1.5em; font-weight: bold; padding: 15px 25px; border: 2px solid #ddd; border-radius: 10px; background-color: #fff; cursor: pointer; transition: all 0.2s; }
        .word-bank-btn:hover { background-color: #f0f8ff; border-color: #4a90e2; }
        .word-bank-btn.hidden { display: none; } 
        #sentence-container.scramble-answer { display: flex; flex-wrap: wrap; gap: 10px; padding: 20px; min-height: 80px; background: #f0f8ff; border: 2px dashed #4a90e2; }
        #sentence-container.scramble-answer .chosen-word { font-size: 1.5em; font-weight: bold; padding: 15px 25px; border-radius: 10px; background-color: #fffbe6; color: #f5a623; cursor: pointer; transition: all 0.2s; }
        #sentence-container.scramble-answer .chosen-word:hover { background-color: #fff; color: #dc3545; }

        /* --- CSS Ph·∫£n h·ªìi --- */
        #feedback-area { margin-top: 25px; display: flex; justify-content: space-between; align-items: center; height: 50px; }
        #feedback-text { font-size: 1.5em; font-weight: bold; }
        #feedback-text.correct { color: #28a745; }
        #feedback-text.incorrect { color: #dc3545; }
        #check-btn { font-size: 1.2em; font-weight: bold; padding: 15px 30px; border: none; border-radius: 10px; background-color: #ffae42; color: white; cursor: pointer; transition: background-color 0.2s; display: none; }
        #check-btn:hover { background-color: #f5a623; }
        #next-btn { font-size: 1.2em; font-weight: bold; padding: 15px 30px; border: none; border-radius: 10px; background-color: #4a90e2; color: white; cursor: pointer; transition: background-color 0.2s; display: none; }
        #next-btn:hover { background-color: #357abd; }
    </style>
</head>
<body>

    <audio id="background-music" loop>
        <source src="nhac_nen.mp3" type="audio/mp3">
        <source src="nhac_nen.ogg" type="audio/ogg"> 
        Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫°c n·ªÅn.
    </audio>

    <div id="start-screen">
        <h1>B√© √în B√†i</h1>
        <p>B√© ƒë√£ h·ªçc ƒë·∫øn b√†i n√†o r·ªìi?</p>
        <select id="lesson-select">
            </select>
        <button id="start-btn">B·∫Øt ƒë·∫ßu!</button>
    </div>

    <main id="main-layout">
        <div id="game-container">
            <div id="header">
                <div id="title">B√© √în B√†i</div>
                <button id="end-btn">K·∫øt th√∫c</button>
                <div id="score">ƒêi·ªÉm: 0</div>
            </div>
            <div id="question-area">
                <button id="speaker-btn">üîà</button>
                <p id="question-text">C√¢u h·ªèi s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...</p>
            </div>
            <div id="sentence-container"></div>
            <div id="answer-options"></div>
            <div id="feedback-area">
                <p id="feedback-text"></p>
                <button id="check-btn">Ki·ªÉm tra</button>
                <button id="next-btn">C√¢u ti·∫øp theo</button>
            </div>
        </div>
        <div id="stats-container">
            <h3>Th·ªëng k√™</h3>
            <div id="chart-bar-container">
                <div id="chart-bar-correct"></div>
            </div>
            <div id="chart-label">0 / 0</div>
        </div>
    </main>

    <script src="questions.js"></script>
    
    <script>
        // --- 1. [M·ªöI] T·ª™ ƒêI·ªÇN V·∫¶N (ƒê·∫¶Y ƒê·ª¶) ---
        // S·∫Øp x·∫øp t·ª´ d√†i nh·∫•t ƒë·∫øn ng·∫Øn nh·∫•t
        const VIETNAMESE_VOWELS = [
            'u√¥m', 'u√¥n', '∆∞∆°m', '∆∞·ªùn', 'u√¥m', 'u√¥n', 'i√™m', 'y√™m', 'i√™n', 'y√™n',
            'u√¢ng', 'uƒÉng', 'i√™ng', 'y√™ng', 'i√™u', 'y√™u', '∆∞∆°u', '∆∞∆°i', 'u√¥i',
            'oang', 'oƒÉn', 'oam', 'oan', 'oai', 'oay',
            '√¥m', '∆°m', 'om', 'am', 'ƒÉm', '√¢m', 'im', 'um', 'em', '√™m',
            'en', '√™n', 'in', 'un', 'on', '√¥n', '∆°n', 'an', 'ƒÉn', '√¢n',
            'ua', '∆∞a', 'ia', 'ya', 'oi', '√¥i', '∆°i', 'ai', 'ay', '√¢y',
            'ui', '∆∞i', 'eo', 'ao', 'au', '√¢u', '√™u', 'iu',
            'a', 'ƒÉ', '√¢', 'e', '√™', 'i', 'y', 'o', '√¥', '∆°', 'u', '∆∞'
        ];
        
        // --- 2. T·ª™ ƒêI·ªÇN PH·ª§ √ÇM GH√âP ---
        const VIETNAMESE_CONSONANTS = ['ngh', 'gh', 'ch', 'kh', 'ng', 'nh', 'ph', 'th', 'tr', 'qu', 'gi'];

        // --- 3. [M·ªöI] DANH S√ÅCH B√ÄI H·ªåC (T·ª™ ·∫¢NH B·∫†N G·ª¨I) ---
        const LESSON_LIST = [
            { id: 1, name: "B√†i 1-3: a, b, c" },
            { id: 5, name: "B√†i 4-5: e, √™ (√în t·∫≠p)" },
            { id: 9, name: "B√†i 6-9: o, √¥, ∆°, d, ƒë (√în t·∫≠p)" },
            { id: 13, name: "B√†i 11-13: i, k, h, l, u, ∆∞" },
            { id: 15, name: "B√†i 14: ch, kh (√în t·∫≠p)" },
            { id: 17, name: "B√†i 16-17: m, n, g, gi" },
            { id: 20, name: "B√†i 18-20: gh, nh, ngh (√în t·∫≠p)" },
            { id: 22, name: "B√†i 21-22: r, s, t, tr" },
            { id: 25, name: "B√†i 23-25: th, ia, ua, ∆∞a (√în t·∫≠p)" },
            { id: 28, name: "B√†i 26-28: ph, qu, v, x, y" },
            { id: 30, name: "B√†i 29-30: Luy·ªán t·∫≠p (√în t·∫≠p)" },
            { id: 32, name: "B√†i 31-32: an, ƒÉn, √¢n, on, √¥n, ∆°n" },
            { id: 35, name: "B√†i 33-35: en, √™n, in, un, am, ƒÉm, √¢m (√în t·∫≠p)" },
            { id: 36, name: "B√†i 36: om, √¥m, ∆°m" },
            { id: 37, name: "B√†i 37: em, √™m, im, um" },
            { id: 38, name: "B√†i 38: ai, ay, √¢y" },
            { id: 40, name: "B√†i 39-40: oi, √¥i, ∆°i (√în t·∫≠p)" },
            { id: 41, name: "B√†i 41: ui, ∆∞i" },
            { id: 42, name: "B√†i 42: ao, eo" },
            { id: 43, name: "B√†i 43: au, √¢u, √™u (B√†i cu·ªëi)" }
        ];

        // --- 4. BI·∫æN TO√ÄN C·ª§C ---
        let currentQuestionIndex = 0;
        let score = 0;
        const synthesis = window.speechSynthesis;
        let mcFirstAttempt = true;
        let shuffledQuestions = [];
        let correctAnswersCount = 0; 
        const bgMusic = document.getElementById('background-music');

        // --- 5. L·∫§Y C√ÅC TH√ÄNH PH·∫¶N HTML ---
        const startScreen = document.getElementById('start-screen');
        const mainLayout = document.getElementById('main-layout');
        const lessonSelect = document.getElementById('lesson-select');
        const startBtn = document.getElementById('start-btn');
        
        const scoreDisplay = document.getElementById('score');
        const questionTextDisplay = document.getElementById('question-text');
        const speakerBtn = document.getElementById('speaker-btn');
        const sentenceContainer = document.getElementById('sentence-container');
        const answerOptionsContainer = document.getElementById('answer-options');
        const feedbackText = document.getElementById('feedback-text');
        const nextBtn = document.getElementById('next-btn');
        const checkBtn = document.getElementById('check-btn');
        const endBtn = document.getElementById('end-btn');
        const statsBar = document.getElementById('chart-bar-correct');
        const statsLabel = document.getElementById('chart-label');

        // --- 6. "B·ªò N√ÉO" v20: H√ÄM B·∫∫ C√ÇU (ƒê√£ s·ª≠a l·ªói) ---
        function tokenizeSentence(sentence) {
            const tokens = [];
            const words = sentence.split(/(\s+)/); 

            for (const word of words) {
                if (word.trim().length === 0) {
                    if (word.length > 0) tokens.push({ type: 'space', text: ' ' });
                    continue;
                }

                let currentWord = word;
                let foundVowel = null;
                let consonant = '';
                
                for (const vowel of VIETNAMESE_VOWELS) {
                    // B·ªè d·∫•u thanh ƒë·ªÉ so s√°nh
                    const simpleWord = word.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
                    const simpleVowel = vowel.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();

                    if (simpleWord.endsWith(simpleVowel)) {
                        // T√¨m th·∫•y v·∫ßn! L·∫•y v·∫ßn g·ªëc (c√≥ d·∫•u)
                        let vowelIndex = simpleWord.lastIndexOf(simpleVowel);
                        foundVowel = word.substring(vowelIndex);
                        consonant = word.substring(0, vowelIndex);
                        break;
                    }
                }

                if (!foundVowel) {
                    tokens.push({ type: 'consonant', text: word });
                    continue;
                }
                
                if (consonant) {
                    tokens.push({ type: 'consonant', text: consonant });
                }
                
                tokens.push({ type: 'vowel', text: foundVowel });
            }
            return tokens;
        }

        // --- 7. C√ÅC H√ÄM C∆† B·∫¢N (Kh√¥ng ƒë·ªïi) ---
        function shuffleArray(array) {
            let newArray = [...array]; 
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        function updateStats(correct, total) {
            if (total === 0) {
                statsBar.style.height = '0%';
                statsLabel.textContent = '0 / 0';
            } else {
                const percentage = (correct / total) * 100;
                statsBar.style.height = `${percentage}%`;
                statsLabel.textContent = `${correct} / ${total}`;
            }
        }
        function tryPlayMusic() {
            if (bgMusic.paused) {
                bgMusic.volume = 0.2; 
                bgMusic.play().catch(error => {});
            }
        }

        // --- 8. C√ÅC H√ÄM CH√çNH C·ª¶A GAME (ƒê√É N√ÇNG C·∫§P) ---
        
        // [M·ªöI] H√†m ch·∫°y khi game b·∫Øt ƒë·∫ßu
        function startGame(maxLesson) {
            currentQuestionIndex = 0;
            score = 0;
            correctAnswersCount = 0;
            scoreDisplay.textContent = `ƒêi·ªÉm: ${score}`;
            updateStats(0, 0); 
            
            if (typeof questions === 'undefined' || questions.length === 0) {
                alert("L·ªñI: Kh√¥ng th·ªÉ t·∫£i t·ªáp 'questions.js'.");
                return;
            }
            
            // [LOGIC V20] L·ªçc c√¢u h·ªèi theo b√†i h·ªçc ƒë√£ ch·ªçn
            let filteredQuestions = questions.filter(q => q.lesson <= maxLesson);
            
            if (filteredQuestions.length === 0) {
                alert("Kh√¥ng c√≥ c√¢u h·ªèi n√†o cho b√†i h·ªçc n√†y. Vui l√≤ng ki·ªÉm tra t·ªáp 'questions.js'.");
                return;
            }

            shuffledQuestions = shuffleArray(filteredQuestions);
            
            // Chuy·ªÉn m√†n h√¨nh
            startScreen.style.display = 'none';
            mainLayout.style.display = 'flex';
            
            showQuestion();
            tryPlayMusic();
        }

        function showQuestion() {
            resetState();
            endBtn.style.display = 'block';
            let currentQuestion = shuffledQuestions[currentQuestionIndex]; 
            questionTextDisplay.textContent = currentQuestion.questionText;
            speakerBtn.onclick = () => {
                let textToSpeak = currentQuestion.speakText || currentQuestion.questionText;
                if (currentQuestion.type === 'click_and_find') {
                    textToSpeak += `. ${currentQuestion.sentence}`;
                } else if (currentQuestion.type === 'scramble') {
                    textToSpeak += ` ${currentQuestion.scrambledWords.join(', ')}`;
                }
                speak(textToSpeak);
                tryPlayMusic(); 
            };
            
            if (['multiple_choice', 'find_word', 'check_spelling', 'fill_in_blank'].includes(currentQuestion.type)) {
                mcFirstAttempt = true; 
                answerOptionsContainer.className = 'multiple-choice';
                displayMultipleChoice(currentQuestion);
            } 
            else if (currentQuestion.type === 'click_and_find') {
                sentenceContainer.className = 'click-find';
                displayClickAndFind(currentQuestion);
                checkBtn.onclick = () => checkAnswer_CF(currentQuestion);
            }
            else if (currentQuestion.type === 'scramble') {
                sentenceContainer.className = 'scramble-answer';
                answerOptionsContainer.className = 'scramble-bank';
                displayScramble(currentQuestion);
                checkBtn.onclick = () => checkAnswer_Scramble(currentQuestion);
            }
        }

        function resetState() {
            nextBtn.style.display = 'none';
            checkBtn.style.display = 'none';
            endBtn.style.display = 'none';
            feedbackText.textContent = '';
            feedbackText.className = '';
            sentenceContainer.innerHTML = '';
            answerOptionsContainer.innerHTML = '';
            sentenceContainer.className = ''; 
            answerOptionsContainer.className = ''; 
        }

        function showFinalScore(completionMessage, totalPlayed) {
            questionTextDisplay.textContent = completionMessage;
            speak(completionMessage);
            updateStats(correctAnswersCount, totalPlayed);
            resetState(); 
            feedbackText.textContent = `T·ªïng ƒëi·ªÉm c·ªßa b√© l√†: ${score}`;
            feedbackText.classList.add('correct');
            nextBtn.textContent = 'Ch∆°i l·∫°i?';
            nextBtn.style.display = 'block';
            
            // [M·ªöI] B·∫•m Ch∆°i l·∫°i s·∫Ω quay v·ªÅ M√†n h√¨nh B·∫Øt ƒë·∫ßu
            nextBtn.onclick = () => {
                mainLayout.style.display = 'none';
                startScreen.style.display = 'block';
            };
            bgMusic.pause();
        }

        // --- 9. C√ÅC H√ÄM X·ª¨ L√ù LOGIC (Kh√¥ng ƒë·ªïi) ---
        
        // --- 9a. Logic D·∫°ng 1, 3, 4, 5 (Tr·∫Øc nghi·ªám)
        function displayMultipleChoice(question) {
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-btn');
                button.addEventListener('click', () => {
                    checkAnswer_MC(option, question.correctAnswer, button);
                    tryPlayMusic(); 
                });
                answerOptionsContainer.appendChild(button);
            });
        }
        function checkAnswer_MC(selectedOption, correctAnswer, clickedButton) {
            const isCorrect = selectedOption === correctAnswer;
            if (isCorrect) {
                giveFeedback(true, 'multiple_choice', mcFirstAttempt);
                Array.from(answerOptionsContainer.children).forEach(button => {
                    button.disabled = true;
                    if(button.textContent === correctAnswer) {
                        button.classList.add('correct');
                    }
                });
            } else {
                mcFirstAttempt = false;
                giveFeedback(false, 'multiple_choice');
                clickedButton.classList.add('incorrect');
                clickedButton.disabled = true;
                const allButtons = Array.from(answerOptionsContainer.children);
                const allDisabled = allButtons.every(btn => btn.disabled);
                if (allDisabled) {
                    nextBtn.style.display = 'block';
                }
            }
        }
        
        // --- 9b. Logic D·∫°ng 2 (B·∫•m t√¨m - v17) ---
        function displayClickAndFind(question) {
            const tokens = tokenizeSentence(question.sentence);
            tokens.forEach(token => {
                const span = document.createElement('span');
                if (token.type === 'space') {
                    span.innerHTML = '&nbsp;'; 
                    span.classList.add('space');
                } else {
                    span.textContent = token.text;
                    span.classList.add('token');
                    span.dataset.type = token.type; 
                    span.addEventListener('click', () => {
                        if (span.classList.contains('correct')) { return; }
                        if (span.classList.contains('incorrect')) { span.classList.remove('incorrect'); } 
                        else if (span.classList.contains('selected')) { span.classList.remove('selected'); } 
                        else { span.classList.add('selected'); }
                        checkBtn.style.display = 'block';
                        feedbackText.textContent = '';
                        feedbackText.className = '';
                        tryPlayMusic();
                    });
                }
                sentenceContainer.appendChild(span);
            });
        }
        function checkAnswer_CF(question) {
            const correctTargets = question.correctAnswers.map(a => a.toLowerCase());
            const allTokens = sentenceContainer.querySelectorAll('.token');
            let correctFound = 0;
            let incorrectSelected = 0;
            let totalCorrectInSentence = 0;

            allTokens.forEach(span => { span.classList.remove('incorrect'); });
            
            allTokens.forEach(span => {
                if (correctTargets.includes(span.textContent.toLowerCase())) {
                    totalCorrectInSentence++;
                }
            });

            allTokens.forEach(span => {
                const tokenText = span.textContent.toLowerCase();
                const isSelected = span.classList.contains('selected');
                const isCorrectTarget = correctTargets.includes(tokenText);

                if (isSelected && isCorrectTarget) {
                    span.classList.remove('selected');
                    span.classList.add('correct');
                    correctFound++;
                } else if (isSelected && !isCorrectTarget) {
                    span.classList.add('incorrect');
                    incorrectSelected++;
                }
            });
            
            if (correctFound === totalCorrectInSentence && incorrectSelected === 0) {
                giveFeedback(true, 'click_and_find', true);
                checkBtn.style.display = 'none';
            } else {
                giveFeedback(false, 'click_and_find');
            }
        }
        
        // --- 9c. Logic D·∫°ng 6 (S·∫Øp x·∫øp)
        let bankButtons = []; 
        function displayScramble(question) {
            bankButtons = []; 
            question.scrambledWords.forEach((word, index) => {
                const bankBtn = document.createElement('button');
                bankBtn.textContent = word;
                bankBtn.classList.add('word-bank-btn');
                bankBtn.dataset.index = index; 
                bankBtn.onclick = () => {
                    bankBtn.classList.add('hidden');
                    const answerBtn = document.createElement('span');
                    answerBtn.textContent = word;
                    answerBtn.classList.add('chosen-word');
                    answerBtn.dataset.bankIndex = index;
                    answerBtn.onclick = () => {
                        answerBtn.remove();
                        bankBtn.classList.remove('hidden');
                    };
                    sentenceContainer.appendChild(answerBtn);
                    checkBtn.style.display = 'block';
                    tryPlayMusic();
                };
                answerOptionsContainer.appendChild(bankBtn);
                bankButtons.push(bankBtn);
            });
        }
        function checkAnswer_Scramble(question) {
            const chosenWords = Array.from(sentenceContainer.querySelectorAll('.chosen-word'))
                                     .map(span => span.textContent);
            const correctWords = question.correctAnswer;
            let isCorrect = chosenWords.length === correctWords.length && 
                            chosenWords.every((word, i) => word === correctWords[i]);
            if (isCorrect) {
                giveFeedback(true, 'scramble', true);
                checkBtn.style.display = 'none';
                sentenceContainer.querySelectorAll('.chosen-word').forEach(btn => {
                    btn.onclick = null;
                    btn.style.cursor = 'default';
                    btn.style.backgroundColor = '#e0ffe0';
                    btn.style.color = '#28a745';
                });
            } else {
                giveFeedback(false, 'scramble');
            }
        }

        // --- 9d. H√†m Ph·∫£n h·ªìi (C·∫≠p nh·∫≠t cho 6 D·∫°ng) ---
        function giveFeedback(isCorrect, type, isFirstAttempt = false) {
            if (isCorrect) {
                feedbackText.textContent = 'Gi·ªèi qu√°! ƒê√∫ng r·ªìi!';
                feedbackText.classList.add('correct');
                
                const isMcType = ['multiple_choice', 'find_word', 'check_spelling', 'fill_in_blank'].includes(type);
                
                if ((isMcType && isFirstAttempt) || 
                    type === 'click_and_find' || 
                    (type === 'scramble' && isFirstAttempt))
                {
                    score += 100;
                    correctAnswersCount++;
                }
                
                scoreDisplay.textContent = `ƒêi·ªÉm: ${score}`;
                nextBtn.style.display = 'block';
            } else {
                let errorMsg = 'Sai r·ªìi! C·ªë l√™n nh√©!';
                if (type === 'click_and_find') {
                    errorMsg = 'Ch∆∞a ƒë√∫ng! Em xem l·∫°i nh√©!';
                } else if (type === 'scramble') {
                    errorMsg = 'Ch∆∞a ƒë√∫ng! Em x·∫øp l·∫°i nh√©!';
                }
                feedbackText.textContent = errorMsg;
                feedbackText.classList.add('incorrect');
            }
            speak(feedbackText.textContent);
        }
        
        // --- 9e. H√†m ƒë·ªçc (ƒê√É S·ª¨A L·ªñI) ---
        function speak(text) {
            if (!synthesis) { alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ch·ª©c nƒÉng ƒë·ªçc.'); return; }
            synthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            
            // [S·ª¨A L·ªñI] ƒê·ªïi synthesis.getValues() th√†nh synthesis.getVoices()
            let voices = synthesis.getVoices(); 
            
            let viVoice = voices.find(voice => voice.lang === 'vi-VN') || voices.find(voice.lang.startsWith('vi'));
            if (viVoice) { utterance.voice = viVoice; } else { utterance.lang = 'vi-VN'; }
            utterance.rate = 0.75; 
            synthesis.speak(utterance);
        }

        // --- 10. C√ÅC H√ÄM S·ª∞ KI·ªÜN (ƒê√É N√ÇNG C·∫§P) ---
        nextBtn.addEventListener('click', () => {
            const totalPlayed = currentQuestionIndex + 1;
            updateStats(correctAnswersCount, totalPlayed);
            currentQuestionIndex++;
            if (currentQuestionIndex < shuffledQuestions.length) {
                showQuestion();
            } else {
                showFinalScore('Ch√∫c m·ª´ng b√© ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u h·ªèi!', shuffledQuestions.length);
            }
            tryPlayMusic();
        });
        endBtn.addEventListener('click', () => {
            // [M·ªöI] T·ªïng s·ªë c√¢u ƒë√£ ch∆°i l√† ch·ªâ s·ªë hi·ªán t·∫°i + 1
            const totalPlayed = currentQuestionIndex + 1;
            showFinalScore('Tr√≤ ch∆°i k·∫øt th√∫c!', totalPlayed);
        });
        
        // [M·ªöI] N·∫°p danh s√°ch b√†i h·ªçc v√†o Menu
        function populateLessonSelect() {
            LESSON_LIST.forEach(lesson => {
                const option = document.createElement('option');
                option.value = lesson.id;
                option.textContent = lesson.name;
                lessonSelect.appendChild(option);
            });
            // T·ª± ƒë·ªông ch·ªçn B√†i 36 cho b·∫°n
            lessonSelect.value = 36;
        }
        
        // [M·ªöI] B·∫Øt ƒë·∫ßu game khi b·∫•m n√∫t Start
        startBtn.addEventListener('click', () => {
            const selectedLesson = lessonSelect.value;
            startGame(selectedLesson);
        });

        // --- 11. B·∫ÆT ƒê·∫¶U GAME KHI T·∫¢I TRANG ---
        // Kh√¥ng t·ª± ch·∫°y game n·ªØa, ch·ªâ n·∫°p danh s√°ch b√†i h·ªçc
        populateLessonSelect();

    </script>
</body>
</html>
